<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width">
	<title>US Forest Service ePermit Middlelayer API Source: utility.js</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	<link type="text/css" rel="stylesheet" href="styles/site.flatly.css">

</head>

<body>

<div class="navbar navbar-default navbar-fixed-top navbar-inverse">
<div class="container">
	<div class="navbar-header">
		<a class="navbar-brand" href="index.html"><img class="branding-logo" src="/images/fs_bw.png"
		alt="logo"/>US Forest Service ePermit Middlelayer API</a>
		<button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#topNavigation">
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
        </button>
	</div>
	<div class="navbar-collapse collapse" id="topNavigation">
		<ul class="nav navbar-nav">
			
			<li class="dropdown">
				<a href="global.html" class="dropdown-toggle" data-toggle="dropdown">Global<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="global.html#combinePropArgument">combinePropArgument</a></li><li><a href="global.html#handleAnyOfError">handleAnyOfError</a></li><li><a href="global.html#makeAnyOfMessage">makeAnyOfMessage</a></li><li><a href="global.html#makeErrorObj">makeErrorObj</a></li><li><a href="global.html#removeInstance">removeInstance</a></li>
				</ul>
			</li>
			
		</ul>
        
            <div class="col-sm-3 col-md-3">
                <form class="navbar-form" role="search">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Search" name="q" id="search-input">
                        <div class="input-group-btn">
                            <button class="btn btn-default" id="search-submit"><i class="glyphicon glyphicon-search"></i></button>
                        </div>
                    </div>
                </form>
            </div>
        
	</div>

</div>
</div>


<div class="container" id="toc-content">
<div class="row">

	
	<div class="col-md-12">
	
		<div id="main">
			

		<h1 class="page-title">Source: utility.js</h1>
    
<section>
    <article>
        <pre
            class="sunlight-highlight-javascript linenums">/*

  ___ ___       ___               _ _       _   ___ ___ 
 | __/ __|  ___| _ \___ _ _ _ __ (_) |_    /_\ | _ \_ _|
 | _|\__ \ / -_)  _/ -_) '_| '  \| |  _|  / _ \|  _/| | 
 |_| |___/ \___|_| \___|_| |_|_|_|_|\__| /_/ \_\_| |___|

*/

//*******************************************************************

'use strict';

//*******************************************************************
// required modules

const jsf = require('json-schema-faker');
const include = require('include')(__dirname);
const path = require('path');
const AWS = require('aws-sdk');
const errors = require('./patternErrorMessages.json');
const async = require('async');

//*************************************************************
// AWS

const AWS_ACCESS_KEY_ID = process.env.AWS_ACCESS_KEY_ID;
const AWS_SECRET_ACCESS_KEY = process.env.AWS_SECRET_ACCESS_KEY;
const AWS_REGION = process.env.AWS_REGION;
const AWS_BUCKET_NAME = process.env.AWS_BUCKET_NAME;

AWS.config.update({
	accessKeyId: AWS_ACCESS_KEY_ID,
	secretAccessKey: AWS_SECRET_ACCESS_KEY,
	region: AWS_REGION
});

const s3 = new AWS.S3();

//*******************************************************************

function makeFieldReadable(input){

	return input
	.replace(/([A-Z])/g, ' $1')
	.replace(/^./, function(str){
		return str.toUpperCase();
	})
	.replace('Z I P', 'Zip')
	.replace('U R L', 'URL');

}

function makePathReadable(input){

	if (typeof input === 'string'){
		const parts = input.split('.');
		const readableParts = [];
		let readablePath = '';
		parts.forEach((field)=>{
			readableParts.push(makeFieldReadable(field));
		});
		readablePath = readableParts.shift();
		readableParts.forEach((part)=>{
			readablePath = `${readablePath}/${part}`;
		});
		return readablePath;
	}
	else {
		return false;
	}

}

function buildFormatErrorMessage(fullPath){
	const field = fullPath.substring(fullPath.lastIndexOf('.') + 1);
	const readablePath = makePathReadable(fullPath);
	const errorMessage = `${readablePath}${errors[field]}`;
	return errorMessage;

}

/**
 * Creates error message for anyOf errors
 * 
 * @param  {string|string[]} anyOfFields - list of fields, at least one being required.
 * @return {string}
 */
function makeAnyOfMessage(anyOfFields){
	if (anyOfFields){
		let output, count = 1;
		const length = anyOfFields.length;
		output = `${makePathReadable(anyOfFields[0])}`;
		while (count &lt; length) {
			const field = anyOfFields[count];
			output = `${output} or ${makePathReadable(field)}`;
			count ++;
		}
		return output;
	}
	else {
		return false;
	}
}

function concatErrors(errorMessages){

	let output = '';
	errorMessages.forEach((message)=>{
		output = `${output}${message} `;
	});
	output = output.trim();
	return output;
}

function buildErrorMessage(output){

	let errorMessage = '';
	const messages = [];
	output.errorArray.forEach((error)=>{

		const missing = `${makePathReadable(error.field)} is a required field.`;
		const type = `${makePathReadable(error.field)} is expected to be type '${error.expectedFieldType}'.`;
		const enumMessage = `${makePathReadable(error.field)} ${error.enumMessage}.`;
		const dependencies = `Having ${makePathReadable(error.field)} requires that ${makePathReadable(error.dependency)} be provided.`;
		const anyOf = `Either ${makeAnyOfMessage(error.anyOfFields)} is a required field.`;

		switch (error.errorType){
		case 'missing':
			messages.push(missing);
			break;
		case 'type':
			messages.push(type);
			break;
		case 'format':
		case 'pattern':
			messages.push(buildFormatErrorMessage(error.field));
			break;
		case 'enum':
			messages.push(enumMessage);
			break;
		case 'dependencies':
			messages.push(dependencies);
			break;
		case 'anyOf':
			messages.push(anyOf);
			break;
		}

	});
	errorMessage = concatErrors(messages);
	return errorMessage;

}

const pad = function (n) {
	return  ('0' + n).slice(-2);
};

const generatePurpose = function (activityDescription, locationDescription, startDateTime, endDateTime){

	let purpose = '';

	if (activityDescription){
		purpose = purpose + activityDescription + ' ' ;
	}
	if (locationDescription){
		purpose = purpose + locationDescription + ' ';
	}
	if (startDateTime){
		purpose = purpose + startDateTime + ' ';
	}
	if (endDateTime){
		purpose = purpose + endDateTime + ' ';
	}

	purpose = purpose.trim();

	return purpose;

};

function fromAdminOrg(cnData, postSchema, jsonData, key){

	const adminOrg = cnData[postSchema.adminOrg.intake];
	switch (key){
	case 'region':
		jsonData[key] = adminOrg.slice(0, 2);
		break;
	case 'forest':
		jsonData[key] = adminOrg.slice(2, 4);
		break;
	case 'district':
		jsonData[key] = adminOrg.slice(4, 6);
		break;
	}

}

function getTopLevelField(intakeField, cnData, postSchema, jsonData, key){

	switch (intakeField){
		case 'none':
			break;
		case 'fromAdminOrg':
			fromAdminOrg(cnData, postSchema, jsonData, key);
			break;
		default:
			if (cnData.hasOwnProperty(postSchema[key].intake)){
	
				jsonData[key] = cnData[postSchema[key].intake];
		
			}
	}

}

function getSubLevelField(cnData, postSchema, key, jsonData){

	const addressData = cnData.addresses[0];
	const phoneData = cnData.phones[0];
	const holderData = cnData.holders[0];
	const path = postSchema[key].intake.split('/');
	let data;
	switch (path[0]){
	case 'holders':
		data = holderData;
		break;
	case 'phones':
		data = phoneData;
		break;
	case 'addresses':
		data = addressData;
		break;
	}
	if (data.hasOwnProperty(path[1])){
		jsonData[key] = data[path[1]];
	}

}

function buildGetResponse(cnData, applicationData, schemaData, jsonData, postSchema){

	let key; 
	for (key in schemaData){
		
		if (typeof jsonData[key] !== 'object'){
			
			const intakeField = postSchema[key].intake;

			if (intakeField.startsWith('middleLayer/')){
				const applicationField = intakeField.split('/')[1];
				jsonData[key] = applicationData[applicationField];
			}
			else {

				if (intakeField.indexOf('/') === -1){
					getTopLevelField(intakeField, cnData, postSchema, jsonData, key);	
				}
				else {
					
					getSubLevelField(cnData, postSchema, key, jsonData);
				}
			}
			
		}
		else {
			buildGetResponse(cnData, applicationData, schemaData[key], jsonData[key], postSchema[key]);
		}
	}

}
function copyGenericInfo(cnData, applicationData, jsonData){

	const postSchema = include('controllers/permits/applications/special-uses/getSchema.json');
	jsf.option({useDefaultValue:true});
	const schemaData = jsf(postSchema);
	delete schemaData.id;

	jsonData = schemaData;

	buildGetResponse(cnData, applicationData, schemaData, jsonData, postSchema);

	/*
		Lock down all fields expected to be returned
	*/

	return jsonData;
}

function autoPopulatedFields(postData, inputPost){

	let combId = '', purpose;

	combId = pad(inputPost.region);
	combId = combId + pad(inputPost.forest);
	combId = combId + pad(inputPost.district);

	postData.securityId = combId;
	postData.managingOrg = combId;
	postData.adminOrg = combId;

	const todayDate = new Date().toISOString().slice(0, 10);
	postData.effectiveDate = todayDate;

	if (inputPost.applicantInfo.organizationName){
		postData.applicantInfo.contactType = 'ORGANIZATION'; 
	}
	else {
		postData.applicantInfo.contactType = 'PERSON'; 
	}
	
	if (postData.applicantInfo.contactType === 'ORGANIZATION'){
		postData.applicantInfo.contName = inputPost.applicantInfo.organizationName;
	}
	else {
		postData.applicantInfo.contName = inputPost.applicantInfo.firstName + ' ' + inputPost.applicantInfo.lastName;
	}

	if (inputPost.type === 'noncommercial'){

		postData.type = 'noncommercial';

		purpose = generatePurpose (postData.noncommercialFields.activityDescription,
										postData.noncommercialFields.locationDescription,
										postData.noncommercialFields.startDateTime,
										postData.noncommercialFields.endDateTime);

		postData.noncommercialFields.purpose = purpose;
		delete postData.tempOutfitterFields;

	}
	else if (inputPost.type === 'tempOutfitters'){

		postData.type = 'tempOutfitters';

		purpose = generatePurpose (postData.tempOutfitterFields.activityDescription,
										postData.tempOutfitterFields.locationDescription,
										postData.tempOutfitterFields.startDateTime,
										postData.tempOutfitterFields.endDateTime);

		postData.tempOutfitterFields.purpose = purpose;
		delete postData.noncommercialFields;
	}

	delete postData.id;

}

function populatePostData(inputPost, postData, schemaData){

	let fieldKey = '';
	for (fieldKey in schemaData){
		if (inputPost.hasOwnProperty(fieldKey)){
			if (typeof inputPost[fieldKey] !== 'object'){
				postData[fieldKey] = inputPost[fieldKey];
			}
			else {
				populatePostData(inputPost[fieldKey], postData[fieldKey], schemaData[fieldKey]);
			}
		}
	}

}

function createPost(controlNumber, inputPost){
	
	const postSchema = include('controllers/permits/applications/special-uses/postSchema.json'); 
	jsf.option({useDefaultValue:true});
	const schemaData = jsf(postSchema);
	
	const postData = schemaData;

	if (inputPost.body) {
		inputPost = JSON.parse(inputPost.body);
	}
	
	populatePostData(inputPost, postData, schemaData);
	autoPopulatedFields(postData, inputPost);

	return postData;
	
}

function uploadFiles(controlNumber, files, callback){
 
	const asyncTasks = [];

	files.forEach(function(file){

		asyncTasks.push(function(callback){
			
			const params = {
				Bucket: AWS_BUCKET_NAME, 
				Key: file.keyname,
				Body: file.buffer,
				ACL: 'private' 
			};

			s3.putObject(params, function(err, data) {
				if (err) {
					console.error(err, err.stack);
					return callback(err, null);
				}
				else {     
					return callback(null, data);
				}      
			});	

		});

	});
	async.parallel(asyncTasks, function(err, data){
		if (err){
			return callback(err, null);
		}
		else {
			return callback(null, data);		
		}
	});

}

//*******************************************************************
// exports

module.exports.buildErrorMessage = buildErrorMessage;
module.exports.concatErrors = concatErrors;
module.exports.copyGenericInfo = copyGenericInfo;
module.exports.createPost = createPost;
module.exports.uploadFiles = uploadFiles;
</pre>
    </article>
</section>





		</div>
	</div>

	<div class="clearfix"></div>

	

</div>
</div>


    <div class="modal fade" id="searchResults">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title">Search results</h4>
          </div>
          <div class="modal-body"></div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          </div>
        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div>


<footer>


<span class="jsdoc-message">
	Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a>
	
		on April 10, 2017
	
	using the <a href="https://github.com/docstrap/docstrap">DocStrap template</a>.
</span>
</footer>

<script src="scripts/docstrap.lib.js"></script>
<script src="scripts/toc.js"></script>

    <script type="text/javascript" src="scripts/fulltext-search-ui.js"></script>


<script>
$( function () {
	$( "[id*='$']" ).each( function () {
		var $this = $( this );

		$this.attr( "id", $this.attr( "id" ).replace( "$", "__" ) );
	} );

	$( ".tutorial-section pre, .readme-section pre, pre.prettyprint.source" ).each( function () {
		var $this = $( this );

		var example = $this.find( "code" );
		exampleText = example.html();
		var lang = /{@lang (.*?)}/.exec( exampleText );
		if ( lang && lang[1] ) {
			exampleText = exampleText.replace( lang[0], "" );
			example.html( exampleText );
			lang = lang[1];
		} else {
			var langClassMatch = example.parent()[0].className.match(/lang\-(\S+)/);
			lang = langClassMatch ? langClassMatch[1] : "javascript";
		}

		if ( lang ) {

			$this
			.addClass( "sunlight-highlight-" + lang )
			.addClass( "linenums" )
			.html( example.html() );

		}
	} );

	Sunlight.highlightAll( {
		lineNumbers : true,
		showMenu : true,
		enableDoclinks : true
	} );

	$.catchAnchorLinks( {
        navbarOffset: 10
	} );
	$( "#toc" ).toc( {
		anchorName  : function ( i, heading, prefix ) {
			return $( heading ).attr( "id" ) || ( prefix + i );
		},
		selectors   : "#toc-content h1,#toc-content h2,#toc-content h3,#toc-content h4",
		showAndHide : false,
		smoothScrolling: true
	} );

	$( "#main span[id^='toc']" ).addClass( "toc-shim" );
	$( '.dropdown-toggle' ).dropdown();

    $( "table" ).each( function () {
      var $this = $( this );
      $this.addClass('table');
    } );

} );
</script>



<!--Navigation and Symbol Display-->


<!--Google Analytics-->



    <script type="text/javascript">
        $(document).ready(function() {
            SearcherDisplay.init();
        });
    </script>


</body>
</html>
